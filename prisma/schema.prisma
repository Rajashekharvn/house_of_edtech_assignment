generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @default(uuid())
  clerkId   String   @unique
  email     String   @unique
  firstName String?
  lastName  String?
  bio       String?
  isPrivate Boolean  @default(false)
  dailyGoal Int      @default(30) // Minutes


  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  streakCount   Int      @default(0)
  lastStudyDate DateTime?

  learningPaths LearningPath[]
  quizAttempt   QuizAttempt[]
  stars         PathStar[]
  
  followedBy    Follows[] @relation("following")
  following     Follows[] @relation("follower")
  notifications Notification[]
}

model LearningPath {
  id          String   @id @default(uuid())
  title       String
  description String?
  category    String?
  difficulty  String?
  isPublic    Boolean  @default(false)
  clonedFromId String?
  isModified  Boolean  @default(true)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  

  resources   Resource[]
  
  quiz        Quiz?
  flashcards  Flashcard[]
  stars       PathStar[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([isPublic, category])
  @@index([isPublic, createdAt]) // Optimized for "Newest Public Paths"
}

model Resource {
  id          String   @id @default(uuid())
  title       String
  url         String?
  content     String?  // For code snippets or text notes
  type        String
  summary     String?  // AI Generated
  isCompleted Boolean  @default(false)
  
  pathId      String
  path        LearningPath @relation(fields: [pathId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([pathId])
}

model Flashcard {
  id          String   @id @default(uuid())
  front       String   // Term or Question
  back        String   // Definition or Answer
  isMastered  Boolean  @default(false)
  
  pathId      String
  path        LearningPath @relation(fields: [pathId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Quiz {
  id          String   @id @default(uuid())
  questions   Json     // Stores array of { question, options[], answer }
  
  pathId      String   @unique
  path        LearningPath @relation(fields: [pathId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  attempts    QuizAttempt[]
}

model QuizAttempt {
  id             String   @id @default(uuid())
  score          Int
  totalQuestions Int
  passed         Boolean  @default(false)
  
  quizId         String
  quiz           Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt      DateTime @default(now())
  
  @@index([userId])
  @@index([quizId])
}

model PathStar {
  id        String       @id @default(uuid())
  userId    String
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  pathId    String
  path      LearningPath @relation(fields: [pathId], references: [id], onDelete: Cascade)
  createdAt DateTime     @default(now())

  @@unique([userId, pathId])
}

model Follows {
  followerId  String
  followingId String
  follower    User   @relation("follower", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("following", fields: [followingId], references: [id], onDelete: Cascade)
  isAccepted  Boolean  @default(true)
  createdAt   DateTime @default(now())

  @@id([followerId, followingId])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String   // STAR, FOLLOW
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  
  actorId   String?
  pathId    String?

  @@index([userId, createdAt]) // Optimized for "User's latest notifications"
  @@index([userId, isRead])    // Optimized for "User's unread notifications"
}
